```{r warning = FALSE, message = FALSE}
library(car)
library(dplyr)
library(reshape2)
library(ggplot2)
library(latex2exp)
library(data.table)
library(polycor)
library(reghelper)
library(lmerTest)
```

```{r eval = FALSE}
sim.data <- function(b3, r12, r13, r23){
  set.seed(11)
  
  # number of observations to simulate
  nobs = 1000
 
  # Using a correlation matrix (let' assume that all variables
  # have unit variance
  M = matrix(c(1, r12, r13,
               r12, 1, r23,
               r13, r23, 1), nrow = 3, ncol = 3)
 
  # Cholesky decomposition
  L = chol(M)
  nvars = dim(L)[1]
 
  # R chol function produces an upper triangular version of L
  # so we have to transpose it.
  # Just to be sure we can have a look at t(L) and the
  # product of the Cholesky decomposition by itself

  # t(L) %*% L
 
  # Random variables that follow an M correlation matrix
  r = t(L) %*% matrix(rnorm(nvars * nobs), nrow = nvars, ncol = nobs)
  r = t(r)
 
  rdata = as.data.frame(r)
  names(rdata) = c('intervention', 'pretest.score', 'effort.score')

  rdata$intervention = ifelse(rdata$intervention > 0, 1, 0)

  # print(cor(rdata))
  
  rdata <- rdata %>%
    mutate(posttest.score = -0.25 + 0.4 * pretest.score + 0.5 * intervention + b3 * effort.score +
             rnorm(nobs, 0, 0.8))
  
  # return(rdata)
  
  # print(cor(rdata))
  
  coef(lm(posttest.score ~ pretest.score + intervention, rdata))['intervention'] - 0.5
}
```

```{r eval = FALSE}
b3.vec <- seq(-0.5, 0.5, 0.05)
b3.vec

small.cors <- as.vector(sapply(b3.vec, sim.data, r12 = 0.25, r13 = 0.25, r23 = 0.2))

small.cors.opp <- as.vector(sapply(b3.vec, sim.data, r12 = 0.25, r13 = -0.25, r23 = 0.2))

mod.cors <- as.vector(sapply(b3.vec, sim.data, r12 = 0.5, r13 = 0.5, r23 = 0.4))

multicol.cors <- as.vector(sapply(b3.vec, sim.data, r12 = 0.25, r13 = 0.25, r23 = 0.75))

df <- data.frame(b3 = b3.vec, small.cors = small.cors, small.cors.opp = small.cors.opp, mod.cors = mod.cors, multicol.cors = multicol.cors) %>%
  melt(., id.vars = 'b3')

df

ggplot(df, aes(x = b3, y = value, color = variable)) +
  #geom_point() +
  theme_classic() +
  geom_line(size = 1) +
  labs(x = TeX('$\\beta_3$'), y = TeX('Absolute bias on $\\beta_1$')) +
  scale_color_discrete(name = 'Correlations', labels = list(TeX('$r_{12} \\approx r_{13} \\approx r_{23} \\approx 0.2$'), TeX('$r_{12} \\approx r_{23} \\approx 0.2$, $r_{13} \\approx -0.2$'), TeX('$r_{12} \\approx r_{13} \\approx r_{23} \\approx 0.4$'), TeX('$r_{12} \\approx r_{23} \\approx 0.2$, $r_{13} \\approx 0.75$'))) +
  theme(plot.margin = unit(c(0.5, 1, 0.5, 0.5), 'cm'))
```


```{r eval = FALSE}
# rdata <- sim.data(b3 = 0.1, r12 = 0.25, r13 = 0.25, r23 = 0.75)
# 
# mean(rdata$posttest.score)
# sd(rdata$posttest.score)
# hist(rdata$posttest.score)
# 
# summary(lm(posttest.score ~ pretest.score + intervention, rdata))
# summary(lm(posttest.score ~ pretest.score + intervention + effort.score, rdata))
# 
# library(ggplot2)
# ggplot(rdata, aes(x = pretest.score, y = posttest.score, color = factor(intervention))) +
#   geom_point() +
#   geom_smooth(method = 'lm')
```

**Load real data**
```{r}
Load.Clean.Data <- function(File = 'C:/Users/Cole/Documents/GRA_Summer2019/MasterDiagnosticDataConstruction/MasterData.csv',
                            assessment, impute = FALSE) {
  
  df <- fread(File)
  if(impute){
    vars <- c('Class_Standing', 'Gender', 'URM_Status', 'First_Gen_Status', 'GPA', 'AP_Calculus_AB', 'AP_Calculus_BC', 'ACT_SAT_Math_Percentile', 'PreScores', 'PostScores', 'Season', 'Sequence', 'Course_Content', 'Instruction', 'IntendedMajor', 'Class')
    df.assessment <- df[Assessment == assessment]
    # df.assessment <- df[Assessment == assessment & (!is.na(PreScores) | !is.na(PostScores))]
    print(nrow(df.assessment))
  } else {
    vars <- c('Class_Standing', 'Gender', 'URM_Status', 'First_Gen_Status', 'AP_Calculus_AB', 'AP_Calculus_BC',
    'ACT_SAT_Math_Percentile', 'PreScores', 'PostScores', 'Season', 'Sequence', 'Course_Content', 'Instruction', 'IntendedMajor', 'Class')
    df.assessment <- df[Assessment == assessment & (!is.na(PreScores) & !is.na(PostScores))]
  }
  
  df.assessment <- df.assessment %>%
    select(vars) %>%
    mutate(Class_Standing = relevel(as.factor(case_when(
      Class_Standing == 'Fresh' ~ 'FY',
      Class_Standing == 'Sophomore' | Class_Standing == 'Junior' | Class_Standing == 'Senior' ~ 'BFY',
      TRUE ~ NA_character_
    )), ref = 'FY'),
    Gender = relevel(as.factor(Gender), ref = 'M'),
    URM_Status = relevel(as.factor(URM_Status), ref = 'Majority'),
    First_Gen_Status = relevel(as.factor(First_Gen_Status), ref = 'ContGen'),
    AP_Calculus_AB = factor(AP_Calculus_AB, levels = c('NotTaken', 'Poor', 'Well'), ordered = TRUE),
    AP_Calculus_BC = factor(AP_Calculus_BC, levels = c('NotTaken', 'Poor', 'Well'), ordered = TRUE),
    Season = relevel(as.factor(Season), ref = 'FA'),
    Sequence = relevel(as.factor(Sequence), ref = 'Engineering'),
    Instruction = relevel(as.factor(Instruction), ref = 'Old'),
    Course_Content = as.factor(Course_Content),
    Class = as.factor(Class),
    ACT_SAT_Math_Percentile = ACT_SAT_Math_Percentile)
    # PreScores = c(scale(PreScores, scale = TRUE)),
    # PostScores = c(scale(PostScores, scale = TRUE)))
  
  if(assessment == 'PLIC' | assessment == 'ECLASS'){
    df.assessment$IntendedMajor <- relevel(as.factor(df.assessment$IntendedMajor), ref = 'EngineeringOrOtherSci')
  }
  
  if(impute){
    levels(df.assessment$Class) <- 1:length(levels(df.assessment$Class))
    df.assessment$Class <- as.numeric(df.assessment$Class)
    
    Frac.Missing <- round(sum(is.na(df.assessment$PreScores) |
                                is.na(df.assessment$PostScores))/nrow(df.assessment) * 100)
    print(Frac.Missing)
    
    ini <- mice(df.assessment, maxit = 0)
    predM <- ini$predictorMatrix
    iniM <- ini$method
    
    predM[, 'Class'] <- -2
    # print(iniM)
    iniM <- c('', '', '', '', '', '', '', '', '2l.pmm', '2l.pmm', '', '', '', '')
    # iniM <- c('', '', '', '', '', '', '', '2l.pmm', '2l.pmm', '', '', '', '')
    
    set.seed(11)
    imp.dat <- mice(df.assessment, m = Frac.Missing, pred = predM, met = iniM, print = FALSE)
    return(imp.dat)
  }
  return(df.assessment)
                            }
```


```{r eval = FALSE}
df.MBT <- Load.Clean.Data(assessment = 'MBT') %>%
  select(-c('Course_Content', 'Class', 'IntendedMajor'))

hetcor(df.MBT)

mod.MBT.1 <- lm(PostScores ~ PreScores + Instruction, df.MBT)
mod.MBT.2 <- lm(PostScores ~ PreScores + Instruction + Season, df.MBT)

summary(mod.MBT.1)
# class(mod.MBT.1) <- 'lmerMod'
beta(mod.MBT.1, skip = 'Instruction')
summary(mod.MBT.2)
# class(mod.MBT.2) <- 'lmerMod'
beta(mod.MBT.2, skip = c('Instruction', 'Sequence'))
```

```{r eval = FALSE}
df.CSEM <- Load.Clean.Data(assessment = 'CSEM') %>%
  select(-c('Course_Content', 'Class', 'IntendedMajor'))
hetcor(df.CSEM)

mod.CSEM.1 <- lmer(PostScores ~ PreScores + Instruction + (1 | Class), df.CSEM)
mod.CSEM.2 <- lmer(PostScores ~ PreScores + Instruction + Season + (1 | Class), df.CSEM)

summary(mod.CSEM.1)
class(mod.CSEM.1) <- 'lmerMod'
beta(mod.CSEM.1, skip = 'Instruction')
summary(mod.CSEM.2)
class(mod.CSEM.2) <- 'lmerMod'
beta(mod.CSEM.2, skip = c('Instruction', 'Season'))
```

```{r eval = FALSE}
df.PLIC <- Load.Clean.Data(assessment = 'PLIC') %>%
  filter(IntendedMajor != '')
#hetcor(df.PLIC)

mod.PLIC.1 <- lmer(PostScores ~ PreScores + Instruction + (1 | Class), df.PLIC)
mod.PLIC.2 <- lmer(PostScores ~ PreScores + Instruction + Season + (1 | Class), df.PLIC)

summary(mod.PLIC.1)
class(mod.PLIC.1) <- 'lmerMod'
beta(mod.PLIC.1, skip = 'Instruction')
summary(mod.PLIC.2)
class(mod.PLIC.2) <- 'lmerMod'
beta(mod.PLIC.2, skip = c('Instruction', 'IntendedMajor'))
```

```{r}
df.ECLASS <- Load.Clean.Data(assessment = 'ECLASS') %>%
  filter(IntendedMajor != '') %>%
  select(-c('Class'))
#hetcor(df.ECLASS)

mod.ECLASS.1 <- lm(PostScores ~ PreScores + IntendedMajor, df.ECLASS)
mod.ECLASS.2 <- lm(PostScores ~ PreScores + Instruction + Sequence, df.ECLASS)
mod.ECLASS.3 <- lm(PostScores ~ PreScores + Instruction + IntendedMajor, df.ECLASS)

summary(mod.ECLASS.1)
#class(mod.ECLASS.1) <- 'lmerMod'
beta(mod.ECLASS.1, skip = 'Instruction')

summary(mod.ECLASS.2)
#class(mod.ECLASS.3) <- 'lmerMod'
beta(mod.ECLASS.2, skip = c('Instruction', 'Sequence'))

summary(mod.ECLASS.3)
#class(mod.ECLASS.3) <- 'lmerMod'
beta(mod.ECLASS.3, skip = c('Instruction', 'IntendedMajor'))
```
**My main issue is that the model with sequence and instruction shows a huge OVB effect, but you can also see the standard errors double. We have no engineering classes with the new labs, which is the problem. I've shown this here for the E-CLASS, but its my issue in general when using two or more course-level variables in a model. The conclusions are correct, that we can't disentangle the effect of sequence from instruction, but its more a limitation of the study design. If we had actually intended to do this study and control for sequence, we would've collected data from both sequences. As it stands, its an obvious limitation and distraction in my mind. I didn't consider this problem when I made that plan a few weeks ago, but now that I think about it, I think its a problem with everything I had suggested.**

**Using student-level variables like major, on the other hand, just aren't that strongly correlated with instruction and don't lead to big OVB effects.**


